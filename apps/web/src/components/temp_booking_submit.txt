
  // Handle Booking Form Submission
  const handleBookingSubmit = async (data: BookingRequest) => {
    setIsBookingFormVisible(false); // Hide form
    setLoading(true);
    setShowWelcome(false); // Hide welcome screen

    const textToSend = `YÃªu cáº§u Ä‘áº·t phÃ²ng: ${data.tripDetails.destination}, ${data.tripDetails.numberOfGuests} khÃ¡ch.`;

    // Add user message clearly showing the intent
    const userMessage: Message = {
      id: Date.now().toString(),
      content: `ðŸ“‹ **Phiáº¿u Äáº·t PhÃ²ng ÄÃ£ Gá»­i:**\n- Äiá»ƒm Ä‘áº¿n: ${data.tripDetails.destination}\n- NgÃ y: ${(data.tripDetails.checkInDate) ? dayjs(data.tripDetails.checkInDate).format('DD/MM') : '...'} - ${(data.tripDetails.checkOutDate) ? dayjs(data.tripDetails.checkOutDate).format('DD/MM') : '...'}\n- NgÃ¢n sÃ¡ch: ${data.tripDetails.budgetMinPerNight?.toLocaleString()} - ${data.tripDetails.budgetMaxPerNight?.toLocaleString()} VND\n\nAgent hÃ£y giÃºp tÃ´i tÃ¬m phÃ²ng ngay!`,
      sender: 'user',
      timestamp: new Date()
    };
    setMessages(prev => [...prev, userMessage]);

    // Create Session if needed
    let currentSessionId = sessionId;
    if (!currentSessionId && user?.id) {
      try {
        const newSession = await chatService.createSession(user.id, `Äáº·t phÃ²ng: ${data.tripDetails.destination}`);
        currentSessionId = newSession.id;
        navigate(`/chat/${currentSessionId}`, { replace: true });
      } catch (error) {
        console.error('Failed to create session:', error);
      }
    }

    try {
      // Send to AI with Booking Context
      const request: ChatRequest = {
        message: textToSend,
        language: 'vi',
        context: {
          userId: user?.id,
          sessionId: currentSessionId,
          bookingRequest: data // Attach structured data
        }
      };

      const response = await chatService.sendMessage(request);

      const botMessage: Message = {
        id: Date.now().toString(),
        content: response.content,
        sender: 'assistant',
        timestamp: new Date()
      };
      setMessages(prev => [...prev, botMessage]);

    } catch (error) {
      console.error('Booking Error:', error);
      message.error('Lá»—i khi gá»­i yÃªu cáº§u Ä‘áº·t phÃ²ng');
    } finally {
      setLoading(false);
      setSelectedTool(null); // Reset tool to return to chat mode
    }
  };
